{% extends "layout.html" %}
{% block title %}Help & FAQ - Aegis{% endblock %}

{% block content %}
<style>
    .faq-accordion .card {
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .faq-accordion .card-header {
        padding: 1rem 1.5rem;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .faq-accordion .card-header .icon::after {
        content: '\f078'; /* Font Awesome down arrow */
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        transition: transform 0.3s ease;
    }
    .faq-accordion .card.active .card-header .icon::after {
        transform: rotate(180deg);
    }
    .faq-accordion .card-body {
        max-height: 0;
        overflow: hidden;
        padding: 0 1.5rem;
        transition: max-height 0.4s ease, padding 0.4s ease;
    }
    .faq-accordion .card.active .card-body {
        padding: 1rem 1.5rem;
    }
    .faq-accordion .card-body pre {
        background-color: var(--light-grey);
        padding: 1rem;
        border-radius: var(--border-radius);
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    body.dark-mode .faq-accordion .card-body pre {
        background-color: #2c3e50;
    }
</style>

<div class="card" style="max-width: 900px; margin: auto;" data-aos="fade-up">
    <h2><i class="fas fa-question-circle"></i> Help Center & Guides</h2>
    <p>Find answers, set up permissions, and troubleshoot common issues.</p>

    <div class="faq-accordion" id="faqAccordion">

        <div class="card">
            <div class="card-header">
                <span><i class="fab fa-aws"></i> How to Set Up AWS Permissions</span>
                <span class="icon"></span>
            </div>
            <div class="card-body">
                <p>To scan your AWS account, Aegis needs read-only permissions. We recommend creating a dedicated IAM user for maximum security.</p>
                <strong>Step 1: Create an IAM User</strong>
                <ol>
                    <li>Sign in to your AWS Management Console.</li>
                    <li>Navigate to the <strong>IAM</strong> service.</li>
                    <li>Go to <strong>Users</strong> and click <strong>Add users</strong>.</li>
                    <li>Enter a <strong>User name</strong> (e.g., `AegisScannerUser`) and select <strong>Access key - Programmatic access</strong> for the credential type.</li>
                    <li>Click <strong>Next: Permissions</strong>.</li>
                </ol>
                <strong>Step 2: Attach Policies</strong>
                <ol>
                    <li>Select <strong>Attach existing policies directly</strong>.</li>
                    <li>Search for and check the box for `SecurityAudit`.</li>
                    <li>Search for and check the box for `ReadOnlyAccess`.</li>
                    <li>Click <strong>Next: Tags</strong>, then <strong>Next: Review</strong>.</li>
                </ol>
                <strong>Step 3: Create User and Get Keys</strong>
                <ol>
                    <li>Review the details and click <strong>Create user</strong>.</li>
                    <li><strong>Important:</strong> On the final screen, copy the <strong>Access key ID</strong> and <strong>Secret access key</strong>. You will not be able to see the secret key again.</li>
                    <li>Enter these keys when adding a new AWS credential profile in the Aegis settings.</li>
                </ol>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span><i class="fab fa-google"></i> How to Set Up GCP Permissions</span>
                <span class="icon"></span>
            </div>
            <div class="card-body">
                <p>Aegis uses a Service Account to scan your GCP project. This ensures the scanner has limited, specific permissions.</p>
                <strong>Step 1: Create a Service Account</strong>
                <ol>
                    <li>In the Google Cloud Console, navigate to <strong>IAM & Admin</strong> > <strong>Service Accounts</strong>.</li>
                    <li>Click <strong>+ CREATE SERVICE ACCOUNT</strong>.</li>
                    <li>Give it a name (e.g., `aegis-scanner`) and a description. Click <strong>CREATE AND CONTINUE</strong>.</li>
                </ol>
                <strong>Step 2: Grant Roles</strong>
                <ol>
                    <li>In the "Grant this service account access to project" step, click the <strong>Role</strong> dropdown.</li>
                    <li>Search for and add the following roles:
                        <ul>
                            <li>`Viewer` (Provides read-only access to most resources).</li>
                            <li>`Security Reviewer` (Allows viewing security policies).</li>
                        </ul>
                    </li>
                    <li>Click <strong>CONTINUE</strong>, then <strong>DONE</strong>.</li>
                </ol>
                <strong>Step 3: Create and Download JSON Key</strong>
                <ol>
                    <li>Find your newly created service account in the list and click on its email address.</li>
                    <li>Go to the <strong>KEYS</strong> tab.</li>
                    <li>Click <strong>ADD KEY</strong> > <strong>Create new key</strong>.</li>
                    <li>Select <strong>JSON</strong> as the key type and click <strong>CREATE</strong>.</li>
                    <li>A JSON file will download. This is your key.</li>
                    <li>Open the downloaded file, copy its entire content, and paste it into the "GCP Service Account JSON Key" field when adding a new GCP profile in Aegis.</li>
                </ol>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-wrench"></i> Troubleshooting Common Errors</span>
                <span class="icon"></span>
            </div>
            <div class="card-body">
                <strong>Error: "InvalidClientTokenId" or "SignatureDoesNotMatch" (AWS)</strong>
                <p>This means your AWS Access Key ID or Secret Access Key is incorrect. Please delete the credential profile in Aegis and create a new one, carefully copying the keys from AWS.</p>

                <strong>Error: "AccessDenied" (AWS)</strong>
                <p>The IAM user for Aegis is missing permissions. Ensure the `SecurityAudit` and `ReadOnlyAccess` policies are attached to the user in the AWS IAM console.</p>

                <strong>Error: "Could not initialize GCP clients" (GCP)</strong>
                <p>This usually means the JSON key is invalid or the necessary APIs are not enabled.
                <br>1. Ensure you copied the *entire* content of the JSON file.
                <br>2. Make sure the "Cloud Resource Manager API" is enabled in your GCP project.</p>

                <strong>Error: "Test email failed" during setup</strong>
                <p>This typically happens if you are using a standard Gmail account without an "App Password". Google requires a special 16-digit password for apps. You can generate one here: <a href="https://myaccount.google.com/apppasswords" target="_blank">Google App Passwords</a>.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const accordion = document.getElementById('faqAccordion');
    if (accordion) {
        accordion.addEventListener('click', function(e) {
            const cardHeader = e.target.closest('.card-header');
            if (!cardHeader) return;
            
            const card = cardHeader.parentElement;
            const cardBody = card.querySelector('.card-body');
            
            card.classList.toggle('active');
            
            if (card.classList.contains('active')) {
                cardBody.style.maxHeight = cardBody.scrollHeight + 'px';
            } else {
                cardBody.style.maxHeight = '0';
            }
        });
    }
});
</script>
{% endblock %}